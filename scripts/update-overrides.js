import fs from 'fs';
import path from 'path';

const SRC_DIR = path.resolve('.', 'src');
const OUTPUT_FILE = path.resolve(SRC_DIR, 'overrides.tsx');

function hasOverridesFile(moduleDir) {
	// Check for either TS or TSX
	const ts = path.join(moduleDir, 'lib', 'overrides.ts');
	const tsx = path.join(moduleDir, 'lib', 'overrides.tsx');
	return fs.existsSync(ts) || fs.existsSync(tsx);
}

function findModulesWithOverrides(srcDir) {
	const entries = fs.readdirSync(srcDir, { withFileTypes: true });
	return entries
		.filter(e => e.isDirectory())
		.map(e => e.name)
		.filter(name => hasOverridesFile(path.join(srcDir, name)))
		.sort();
}

function generateOverridesContent(modules) {
	const header = `// AUTO-GENERATED FILE. Do not edit.
// Generated by scripts/update-overrides.ts

`;
	const imports = modules.map(m => `import "@${m}/lib/overrides";`).join('\n');
	const footer = imports ? '\n\nexport {};\n' : 'export {};\n';
	return header + imports + footer;
}

function main() {
	try {
		const modules = findModulesWithOverrides(SRC_DIR);
		const content = generateOverridesContent(modules);
		fs.writeFileSync(OUTPUT_FILE, content);
		console.log(`Generated overrides for ${modules.length} module(s) in ${path.relative('.', OUTPUT_FILE)}`);
	} catch (err) {
		console.error('Failed to generate overrides.tsx:', err);
		process.exit(1);
	}
}

main();
